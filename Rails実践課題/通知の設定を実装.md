# 通知設定を実装する
&nbsp; いいね、コメント、フォローされた時に通知を受け取るかの設定をオンオフで切り替えられるように実装します。今回の想定としては、チェックボックスを設けてユーザーがオンオフできるようにします。ぶっちゃけ、この章はリファレンス見れば誰でも簡単にできそうなので超簡潔にまとめます。

## 通知設定用のカラムを追加する
&nbsp; 通知設定用にいいね、コメント、フォローの通知設定のオンオフのデータをレコードとして保存するために新しいカラムを追加します。デフォルトでは、通知を受け取るようにtrueに設定します。

```zsh
$rails g migaration AddNotificationFlagsToUsers
```


db/migrate/●_add_notification_flags_to_users.rb
```rb
class AddNotificationFlagsToUsers < ActiveRecord::Migration[5.2]
  def change
    add_column :users, :notification_on_comment, :boolean, default: true
    add_column :users, :notification_on_like, :boolean, default: true
    add_column :users, :notification_on_follow, :boolean, default: true
  end
end
```

```zsh
$rails db:migrate
```

## ルーティングを設定する
&nbsp; 今回はデータの状態を変更するだけなのでeditとupdateのアクションを設けるようにルーティング設定をします。


config/routes.rb
```rb
namespace :mypage do
    resource :notification_setting, only: %i[edit update]
end
```


## コントローラを設定する
&nbsp; 特段特別な実装はありません。以下のように実装します。

app/controllers/mypage/notification_settings_controller.rb
```rb
class Mypage::NotificationSettingsController < Mypage::BaseController
  def edit
    @user = User.find(current_user.id)
  end

  def update
    @user = User.find(current_user.id)
    if @user.update(notification_settings_params)
      redirect_to edit_mypage_notification_setting_path, success: '設定を更新しました'
    else
      flas.now[:danger] = "設定の更新に失敗しました"
      render :edit
    end
  end

  private

  def notification_settings_params
    params.require(:user).permit(:notification_on_comment, :notification_on_like, :notification_on_follow)
  end
end
```

## viewを実装する
&nbsp; 通知設定用のページとサイドバーの実装をしていきます。railsはちゃんとチェックボックスのフォームも用意してくれています。

app/views/mypage/notification_settings/edit.html.slim
```slim
= form_with model: @user, url: mypage_notification_setting_path, method: :patch, local: true do |f|
  = render 'shared/error_messages', object: f.object
  .form-group
    = f.check_box :notification_on_comment
    = f.label :notification_on_comment

  .form-group
    = f.check_box :notification_on_like
    = f.label :notification_on_like

  .form-group
    = f.check_box :notification_on_follow
    = f.label :notification_on_follow

  = f.submit class: 'btn btn-primary btn-raised'
```


app/views/mypage/shared/_sidebar.html.slim
 ```slim
 li
    = link_to '通知一覧', mypage_activities_path
    hr
 li
    = link_to '通知設定', edit_mypage_notification_setting_path
    hr
```

config/locales/ja.yml
```yml
user:
  notification_on_comment: 'コメント時の通知メール'
  notification_on_like: 'いいね時の通知メール'
  notification_on_follow: 'フォロー時の通知メール'
```

<br>

http://localhost:3000/mypage/notification_setting/editに飛べば、以下のように実装されているはずです。
<br>

[![Image from Gyazo](https://i.gyazo.com/38f234415ccb3b17533d30c007657556.png)](https://gyazo.com/38f234415ccb3b17533d30c007657556)

<br>

## メール通知可否による判定ロジックを追加
&nbsp; それぞれのメール送信時の判定ロジックに条件を追加する。

app/controllers/comments_controller.rb
 ```rb
def create
    @comment = current_user.comments.build(comment_params)
    UserMailer.with(user_from: current_user, user_to: @comment.post.user, comment: @comment).comment_post.deliver_later if @comment.save && @comment.post.user.notification_on_comment?
  end

  def edit

end
```

app/controllers/likes_controller.rb
```rb
def create
    @post = Post.find(params[:post_id])
    UserMailer.with(user_from: current_user, user_to: @post.user, post: @post).like_post.deliver_later if current_user.like(@post) && @post.user.notification_on_like?
end
```

app/controllers/relationships_controller.rb
```rb
def create
    @user = User.find(params[:followed_id])
    UserMailer.with(user_from: current_user, user_to: @user).follow.deliver_later if current_user.follow(@user) && @user.notification_on_follow?
end
```

### これで通知設定を実装できました！
