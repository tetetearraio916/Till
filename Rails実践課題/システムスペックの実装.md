# ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒšãƒƒã‚¯ã‚’å®Ÿè£…ã™ã‚‹
&nbsp; ä»Šå›ã¯ã€ä¸‹è¨˜ã®é …ç›®ã«å¯¾ã—ã¦ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒšãƒƒã‚¯ã‚’å®Ÿè£…ã—ã¾ã™ã€‚ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒšãƒƒã‚¯ã¨ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ å…¨ä½“ãŒæœŸå¾…é€šã‚Šã®æŒ™å‹•ã«ãªã£ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®çµ±åˆãƒ†ã‚¹ãƒˆã§ã™ã€‚

- ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ/å¤±æ•—
- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã§ãã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æˆåŠŸ/å¤±æ•—
- ãƒ•ã‚©ãƒ­ãƒ¼ã§ãã‚‹ã“ã¨
- ãƒ•ã‚©ãƒ­ãƒ¼ã‚’ã¯ãšã›ã‚‹ã“ã¨
- æŠ•ç¨¿ä¸€è¦§ãŒé–²è¦§ã§ãã‚‹
- æ–°è¦æŠ•ç¨¿ã§ãã‚‹
- è‡ªåˆ†ã®æŠ•ç¨¿ã«ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- ä»–äººã®æŠ•ç¨¿ã«ã¯ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œãªã„
- æŠ•ç¨¿ã‚’æ›´æ–°ã§ãã‚‹
- æŠ•ç¨¿ã‚’å‰Šé™¤ã§ãã‚‹
- æŠ•ç¨¿ã®è©³ç´°ç”»é¢ãŒé–²è¦§ã§ãã‚‹
- æŠ•ç¨¿ã«å¯¾ã—ã¦ã„ã„ã­ã§ãã‚‹
- æŠ•ç¨¿ã«å¯¾ã—ã¦ã„ã„ã­ã‚’å¤–ã›ã‚‹

## ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒšãƒƒã‚¯ã‚’ä½¿ã†ãŸã‚ã®æº–å‚™
&nbsp; ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒšãƒƒã‚¯ã§ã¯ã€Chromeã¨ChromeDriverã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ChromeDriverã¯ã€Chromeæ“ä½œã‚’è‡ªå‹•åŒ–ã™ã‚‹ã®ã«å¿…è¦ã§ã™ã€‚

```zsh
$brew install chromedriver
```

ã¾ãŸã€chromeã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¤‰åŒ–ãŒæ¿€ã—ã„ãŸã‚å…ƒã€…å°å…¥ã•ã‚Œã¦ã„ã‚‹æ–¹ã‚‚äºˆã‚æœ€æ–°ç‰ˆã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

```zsh
$brew upgrade chromedriver
```

railsã§chromedriverã‚’ä½¿ã†ãŸã‚ã«gemã®webdriversã‚’å°å…¥ã—ã¾ã™ã€‚ã¾ãŸã€å°å…¥ã•ã‚Œã¦ã„ãªã‘ã‚Œã°ãƒ†ã‚¹ãƒˆè‡ªå‹•åŒ–ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã§ã‚ã‚‹capybaraã¨ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã‚ã‚‹rspec-railsã‚‚å…¥ã‚Œã¡ã‚ƒã£ã¦ãã ã•ã„ï¼

Gemfile
```Gemfile
group :development, :test do
  gem 'rspec-rails'
  gem 'factory_bot_rails'
  gem 'faker'
end

group :test do
  gem 'capybara'
  gem 'selenium-webdriver'
end
```

è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«ä»¥ä¸‹ã‚‚è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

spec/rails_helper.rb
```rb
require 'rspec/rails'
require 'factory_bot'
require 'capybara/rspec'

RSpec.configure do |config|
    #FactoryBot.createãªã©ã®FactoryBotã®éƒ¨åˆ†ã‚’çœç•¥ã™ã‚‹ã“ã¨ãŒã§ãã‚‹
    config.include FactoryBot::Syntax::Methods 
end

```


rspecã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ç”Ÿæˆã•ã‚Œã¾ã™ã€‚

```zsh
$rails g rspec:install
```


## ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒšãƒƒã‚¯ã‚’headlessã«è¨­å®šã™ã‚‹
&nbsp; ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒšãƒƒã‚¯ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã™ã‚‹ã¨ãƒ–ãƒ©ã‚¦ã‚¶ãŒç«‹ã¡ä¸ŠãŒã‚Šã‚·ãƒ¥ãƒŸãƒ¬ãƒ¼ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ä»Šå›ã¯ãƒ†ã‚¹ãƒˆãŒé€šã£ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã‚Œã°ã„ã„ã®ã§ã€ã‚·ãƒ¥ãƒŸãƒ¬ãƒ¼ãƒˆã‚’ã‚ªãƒ•ã«ã—ã¾ã™ã€‚ã¾ãšã¯ã€rspecã®supportãƒ•ã‚©ãƒ«ãƒ€ä¸‹ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã‚ˆã†ã«è¨­å®šã‚’åŠ ãˆã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹ã®ã§ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¤–ã—ã¦ã‚ã’ã¦ãã ã•ã„ã€‚

spec/rails_helper.rb
```rb
Dir[Rails.root.join('spec', 'support', '**', '*.rb')].each { |f| require f }
```

ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ã«è¨­å®šã™ã‚‹ãŸã‚è¨­å®šç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã—ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¿°ã—ã¦ä¸‹ã•ã„ã€‚

spec/support/driver_setting.rb
```rb
RSpec.configure do |config|
  config.before(:each, type: :system) do
    # Specå®Ÿè¡Œæ™‚ã€ãƒ–ãƒ©ã‚¦ã‚¶ãŒè‡ªå‹•ã§ç«‹ã¡ä¸ŠãŒã‚ŠæŒ™å‹•ã‚’ç¢ºèªã§ãã‚‹
    # driven_by(:selenium_chrome)

    # Specå®Ÿè¡Œæ™‚ã€ãƒ–ãƒ©ã‚¦ã‚¶OFF
    driven_by(:selenium_chrome_headless)
  end
end
```

ã“ã‚Œã§ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ã«è¨­å®šã§ãã¦ã„ã‚‹ã¯ãšã§ã™ã€‚(ä»¥ä¸‹ã¯åˆ¥ã®ã‚¢ãƒ—ãƒªã§å®Ÿè£…æ¸ˆã¿ã‚‚ã®ã‚’è©¦ã—ã¦ã„ã¾ã™ã€‚)
[![Image from Gyazo](https://i.gyazo.com/5f61df4f9300414a611b99a3036e875f.gif)](https://gyazo.com/5f61df4f9300414a611b99a3036e875f)

## ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã®ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒšãƒƒã‚¯å®Ÿè£…
&nbsp; ã¾ãšã¯userã®ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ãªã®ã§factorybotã‚’è¨­å®šã—ã¾ã™ã€‚factorybotã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯ã€å„ã‚«ãƒ©ãƒ ã®å€¤ãŒå…¨ã¦ãƒ©ãƒ³ãƒ€ãƒ å€¤ã¨ãªã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹ã¨è‰¯ã„ã‚‰ã—ã„ã€‚ãã®ä¸Šã§å¿…è¦ãªå€¤ã®ã¿æ˜ç¤ºçš„ã«ã—ã¦ã€Œã“ã®ãƒ†ã‚¹ãƒˆã§é‡è¦ãªå€¤ã¯ä½•ã‹ã€ãŒã‚ã‹ã‚Šã‚„ã™ããªã‚‹ã‹ã‚‰ã€‚ä»Šå›ã¯ã€Fakerã‚’ç”¨ã„ã¦ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ã„ãã¾ã™ã€‚

spec/factories/users.rb
```rb
FactoryBot.define do
  factory :user do
    name { Faker::Name.name }
    email { Faker::Internet.email }
    password { 'password' }
    password_confirmation { 'password' }
  end
end
```

<br>

ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã®ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒšãƒƒã‚¯ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚sessionã®rspecã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã—ã‚‡ã†ï¼

```zsh
$rails g rspec:system session
```

ä¸‹è¨˜ã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã®viewã§ã™ã€‚

app/views/sessions/new.html.slim

```slim
main
  .login-register-form
    .login-register-form-inner
      .card.mb-3
        = form_with url: login_path, class: 'card-body session_login', local: true do |f|
          .form-group
              = f.label :email, ' ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', class: 'bmd-label-floating'
              = f.text_field :email, class: 'form-control'
          .form-group
              = f.label :password, 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€€', class: 'bmd-label-floating'
              = f.password_field :password, class: 'form-control'
          = f.submit 'ãƒ­ã‚°ã‚¤ãƒ³', class: 'btn btn-raised btn-primary', id: 'login'
      .card
          .card-body
            | ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„ã§ã™ã‹ï¼Ÿ
            = link_to  "ç™»éŒ²ã™ã‚‹", new_user_path
```

ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã®ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒšãƒƒã‚¯ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã—ãŸã€‚

sessions_spec.rb
```rb
require 'rails_helper'

RSpec.describe "Sessions", type: :system do
  let(:user) { create(:user) }

  describe 'ãƒ­ã‚°ã‚¤ãƒ³' do
    context 'èªè¨¼æƒ…å ±ãŒæ­£ã—ã„å ´åˆ' do
      it 'ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã“ã¨' do
        visit '/login'
        fill_in 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', with: user.email
        fill_in 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰', with: 'password'
        within '.session_login' do
          click_on 'ãƒ­ã‚°ã‚¤ãƒ³'
        end
        expect(current_path).to eq root_path
        expect(page).to have_content 'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ'
      end
    end

    context 'èªè¨¼æƒ…å ±ãŒèª¤ã‚ŠãŒã‚ã‚‹å ´åˆ' do
      it 'ãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„ã“ã¨' do
        visit '/login'
        fill_in 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', with: user.email
        fill_in 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰', with: 'misspassword'
        within '.session_login' do
          click_on 'ãƒ­ã‚°ã‚¤ãƒ³'
        end
        expect(current_path).to eq login_path
        expect(page).to have_content 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ'
      end
    end
  end

  describe 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ' do
    it 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ã“ã¨' do
      login(user)
      click_on 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ'
      expect(current_path).to eq '/login'
      expect(page).to have_content 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ'
    end
  end
end
```


ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã‹ä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨ã€ã€ã€
```zsh
&bin/rspec spec/system/sessions_spec.rb
```

è¦‹äº‹é€šã‚Šã¾ã—ãŸï¼

<a href="https://gyazo.com/4c8c00a08363072f84f110c2cf49d133"><img src="https://i.gyazo.com/4c8c00a08363072f84f110c2cf49d133.png" alt="Image from Gyazo" width="643"/></a>

## ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã€ãƒ•ã‚©ãƒ­ãƒ¼ã®ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒšãƒƒã‚¯å®Ÿè£…
&nbsp; ã¾ãšã¯ã€ã„ã¡ã„ã¡ãƒ­ã‚°ã‚¤ãƒ³ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’ãƒ†ã‚¹ãƒˆã«æ›¸ãã®ã¯ã‚ã‚“ã©ãã•ã„ã®ã§ãƒ­ã‚°ã‚¤ãƒ³ç”¨ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚supportãƒ•ã‚©ãƒ«ãƒ€ä¸‹ã«ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

spec/support/login_support.rb
```rb
module LoginSupport
  def login(user)
    visit '/login'
    fill_in 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', with: user.email
    fill_in 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰', with: 'password'
    click_on 'login'
  end
end
```

ã„ã‹ã«è¨­å®šã‚’åŠ ãˆã‚Œã°login(user)ã‚’ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚

rails_helper.rb
```rb
config.include LoginSupport, type: :system
```


ä¸‹è¨˜ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã®viewã§ã™ã€‚

app/views/users/new.html.slim
```slim
.login-register-form
  .login-register-form-inner
    .card.mb-3
      = form_with model: @user, class: 'card-body', local: true do |f|
        = render 'shared/error_messages', object: @user
        .form-group
          = f.label :name, class: 'bmd-label-floating'
          = f.text_field :name, class: 'form-control'
        .form-group
          = f.label :email, class: 'bmd-label-floating'
          = f.text_field :email, class: 'form-control'
        .form-group
          = f.label :password, class: 'bmd-label-floating'
          = f.password_field :password, class: 'form-control'
        .form-group
          = f.label :password_confirmation, class: 'bmd-label-floating'
          = f.password_field :password_confirmation, class: 'form-control'
        = f.submit 'ç™»éŒ²', class: 'btn btn-raised btn-primary'
    .card
      .card-body
        | ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ã™ã‹
        = link_to  "ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹", login_path
```

<br>

å¯¾ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã®ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒšãƒƒã‚¯ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```rb
require 'rails_helper'

RSpec.describe "Users", type: :system do

  describe 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²' do
    context 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒæ­£ã—ã„å ´åˆ' do
      it 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãŒæˆåŠŸã™ã‚‹ã“ã¨' do
        visit '/users/new'
        within '.login-register-form' do
          fill_in 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å', with: 'Railså¤ªéƒ'
        end
        fill_in 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', with: 'rails@example.com'
        fill_in 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰', with: '12345678'
        fill_in 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰(ç¢ºèª)', with: '12345678'
        click_on 'ç™»éŒ²'
        expect(current_path).to eq root_path
        expect(page).to have_content('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆã«æˆåŠŸã—ã¾ã—ãŸ')
      end
    end

    context 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒèª¤ã‚ŠãŒã‚ã‚‹å ´åˆ' do
      it 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãŒå¤±æ•—ã™ã‚‹ã“ã¨' do
        visit '/users/new'
        within '.login-register-form' do
          fill_in 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å', with: ''
        end
        fill_in 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', with: ''
        fill_in 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰', with: ''
        fill_in 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰(ç¢ºèª)', with: ''
        click_on 'ç™»éŒ²'
        expect(page).to have_content('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„')
        expect(page).to have_content('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„')
        expect(page).to have_content('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯3æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„')
        expect(page).to have_content('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰(ç¢ºèª)ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„')
        expect(page).to have_content('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ')
      end
    end
  end
  
  describe 'ãƒ•ã‚©ãƒ­ãƒ¼' do
    let!(:user) { create(:user) }
    let!(:other_user) { create(:user) }

    before do
      login(user)
    end

    it 'ãƒ•ã‚©ãƒ­ãƒ¼ãŒã§ãã‚‹ã“ã¨' do
      visit root_path
      expect{
        within "#follow-area-#{other_user.id}" do
          click_on 'follow'
          expect(page).to have_css('#unfollow')
        end
      }.to change(user.follows, :count).by(1)
    end

    it 'ãƒ•ã‚©ãƒ­ãƒ¼ã‚’å¤–ã›ã‚‹ã“ã¨' do
      user.follow(other_user)
      visit root_path
      expect{
        within "#follow-area-#{other_user.id}" do
          click_on 'unfollow'
          expect(page).to have_css('#follow')
        end
      }.to change(user.follows, :count).by(-1)
    end
  end
end
  ```

<br>

ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«é€šã‚Šã¾ã—ãŸï¼

[![Image from Gyazo](https://i.gyazo.com/3b04ad696ed7853d100619ee02068266.png)](https://gyazo.com/3b04ad696ed7853d100619ee02068266)

## æŠ•ç¨¿ã®CRUDã€ã„ã„ã­ã®ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒšãƒƒã‚¯å®Ÿè£…
&nbsp; æœ€å¾Œã«æŠ•ç¨¿é–¢é€£ã®ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒšãƒƒã‚¯ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚ã¾ãšã¯ã€postã®factorybotã®ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¾ã™ã€‚

spec/factories/post.rb
```rb
FactoryBot.define do
  factory :post do
    content { Faker::Lorem.word }
    #è¤‡æ•°ç”»åƒä¿å­˜ã®éš›ã«ã€jsonå½¢å¼ã§ä¿å­˜ã™ã‚‹ãŸã‚å¯¾å¿œã—ãŸ([]ã«å€¤ã‚’å…¥ã‚Œãªã‘ã‚Œã°ãªã‚‰ãªã„)
    images { [File.open("#{Rails.root}/spec/fixtures/dummy.jpeg")] }
    user
end
```

ãã—ã¦ãƒ†ã‚¹ãƒˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã—ãŸã€‚viewã¯ä»Šå›çœç•¥ã—ã¾ã™ã€‚

posts_spec.rb
```rb
require 'rails_helper'

RSpec.describe "Posts", type: :system do
  let!(:user) { create(:user) }
  let!(:my_post) { create(:post, user: user) }
  let!(:other_post1) { create(:post) }
  let!(:other_post2) { create(:post) }

  describe 'ãƒã‚¹ãƒˆä¸€è¦§' do

    context 'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹å ´åˆ' do
      before do
        login(user)
        user.follow(other_post1.user)
      end
      it 'ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã¨è‡ªåˆ†ã®æŠ•ç¨¿ã ã‘ãŒé–²è¦§ã§ãã‚‹ã“ã¨' do
        visit root_path
        expect(page).to have_content other_post1.content
        expect(page).to have_content my_post.content
        expect(page).not_to have_content other_post2.content
      end
    end

    context 'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆ' do
      it 'å…¨ã¦ã®ãƒã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨' do
        visit posts_path
        expect(page).to have_content other_post1.content
        expect(page).to have_content my_post.content
        expect(page).to have_content other_post2.content
      end
    end
  end

  describe 'ãƒã‚¹ãƒˆæŠ•ç¨¿' do
    it 'ç”»åƒã‚’æŠ•ç¨¿ã§ãã‚‹ã“ã¨' do
      login(user)
      visit new_post_path
      within '#posts_form' do
        attach_file 'ç”»åƒ', "#{Rails.root}/spec/fixtures/dummy.jpeg"
        fill_in 'æœ¬æ–‡', with: "test"
        click_on 'ç™»éŒ²ã™ã‚‹'
      end
      expect(page).to have_content 'æŠ•ç¨¿ã—ã¾ã—ãŸ'
      expect(page).to have_content 'test'
    end
  end


  describe 'ãƒã‚¹ãƒˆæ›´æ–°' do
    before do
      login(user)
    end

    it 'è‡ªåˆ†ã®æŠ•ç¨¿ã«ç·¨é›†ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨' do
      visit root_path
      within "#post-#{my_post.id}" do
        expect(page).to have_css '.edit-button'
      end
    end


    it 'ä»–äººã®æŠ•ç¨¿ã«ã¯ç·¨é›†ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œãªã„ã“ã¨' do
      user.follow(other_post1.user)
      visit root_path
      within "#post-#{other_post1.id}" do
        expect(page).to_not have_css '.edit-button'
      end
    end


    it 'æŠ•ç¨¿ã‚’æ›´æ–°ã§ãã‚‹ã“ã¨' do
      visit edit_post_path(my_post)
      within '#posts_form' do
        attach_file 'ç”»åƒ', "#{Rails.root}/spec/fixtures/dummy.jpeg"
        fill_in 'æœ¬æ–‡', with: "update"
        click_on 'ç™»éŒ²ã™ã‚‹'
      end
      expect(page).to have_content('æŠ•ç¨¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ')
      expect(page).to have_content("update")
    end
  end

  describe 'æŠ•ç¨¿ã‚’å‰Šé™¤ã§ãã‚‹ã“ã¨' do
    before do
      login(user)
    end

    it 'è‡ªåˆ†ã®æŠ•ç¨¿ã«å‰Šé™¤ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨' do
      visit root_path
      expect(page).to have_css '.delete-button'
    end

    it 'ä»–äººã®æŠ•ç¨¿ã«ã¯å‰Šé™¤ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œãªã„ã“ã¨' do
      user.follow(other_post1.user)
      visit root_path
      within "#post-#{other_post1.id}" do
        expect(page).to_not have_css '.delete-button'
      end
    end

    it 'æŠ•ç¨¿ã‚’å‰Šé™¤ã§ãã‚‹ã“ã¨' do
      visit root_path
      within "#post-#{my_post.id}" do
        page.accept_confirm { find('.delete-button').click }
      end
      expect(page).to have_content("æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ")
      expect(page).not_to have_content(my_post.content)
    end
  end

  describe 'ãƒã‚¹ãƒˆè©³ç´°' do
    before do
      login(user)
    end

    it 'æŠ•ç¨¿ã®è©³ç´°ç”»é¢ãŒé–²è¦§ã§ãã‚‹' do
      visit post_path(my_post)
      expect(current_path).to eq "/posts/#{my_post.id}"
    end
  end

  describe 'ã„ã„ã­é–¢é€£' do
    before do
      login(user)
      user.follow(other_post1.user)
    end

    it 'ã„ã„ã­ãŒã§ãã‚‹ã“ã¨' do
      visit root_path
      expect{
        within "#like_area-#{other_post1.id}" do
          find('.like-button').click
        end
        expect(page).to have_css '.unlike-button'
      }.to change(user.like_posts, :count).by(1)
    end

    it 'ã„ã„ã­ã‚’å¤–ã›ã‚‹ã“ã¨' do
      user.like(other_post1)
      visit root_path
      expect{
        within "#like_area-#{other_post1.id}" do
          find('.unlike-button').click
        end
        expect(page).to have_css '.like-button'
      }.to change(user.like_posts, :count).by(-1)
    end
  end
end
```

<br>

ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«æŠ•ç¨¿é–¢é€£ã®ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒšãƒƒã‚¯ã‚‚é€šã‚Šã¾ã—ãŸï¼

[![Image from Gyazo](https://i.gyazo.com/1814d020a74966abe79979c951e51bc2.png)](https://gyazo.com/1814d020a74966abe79979c951e51bc2)

ã“ã‚Œã§å„é …ç›®ã®ãƒ†ã‚¹ãƒˆãŒå…¨ã¦é€šã‚Šã¾ã—ãŸï¼Rspecé–¢é€£ã¯ã€everyday rspecã‚„ä¼Šè—¤æ·³ä¸€å…ˆç”Ÿã®Qiitaã®è¨˜äº‹ã‚’ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã«ã™ã‚Œã°ãã‚Œãªã‚Šã«ã¯æ›¸ã‘ã‚‹ã¨æ€ã„ã¾ã™ã€‚ãŠç–²ã‚Œæ§˜ã§ã—ãŸğŸ™‡â€


## å‚è€ƒè¨˜äº‹
- [ã€Railsã€‘ã¯ã˜ã‚ã¦ã®SystemSpec(RSpec)](https://qiita.com/niwa1903/items/e1ad9ab39811aa1cf312)
- [RSpec ã‚¹ã‚¿ã‚¤ãƒ«ã‚¬ã‚¤ãƒ‰](https://github.com/willnet/rspec-style-guide)
